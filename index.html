<!DOCTYPE html>
<html lang="en">
  <head>
    <script type="text/javascript" src="https://ngld.github.io/OverlayPlugin/assets/shared/common.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
      body{
        margin: 0px;
        overflow: hidden;
      }
      #main{
        height: 100vh;
        width: 100vw;
        text-align: right;
        padding-right: 20px;
        padding-bottom: 20px;
        opacity: .8;
      }
    </style>
  </head>
  <body>
    <div id="main">
      <!--
      <svg id="svg"
        xmlns="http://www.w3.org/2000/svg"
        height="100%"
        viewBox="0 0 60 266"
      >
        <path
          id="path"
          vector-effect="non-scaling-stroke"
          fill="none"
          stroke="black"
          stroke-width="10"
          stroke-linecap="round"
          d="M 30.00,246.00
             C 0.00,186.00 0.00,70.00 30.00,10.00"
          >
        </path>
        <path
          id="loader1"
          vector-effect="non-scaling-stroke"
          fill="none"
          stroke="green"
          stroke-width="10"
          stroke-linecap="round"
          stroke-dasharray="758"
          stroke-dashoffset="758"
          d="M 30.00,246.00
             C 0.00,186.00 0.00,70.00 30.00,10.00"
          >
        </path>
      </svg>
    -->
    </div>
  </body>
  <footer>
    <script>
      const debug = false;
      const characterName = 'Tonk Tonkers';
      const main = document.getElementById('main');
      // Will be used to hold our progress bars for easy access
      const progressBars = [];

      // Contents vary based on messageType
      const eventType = 'LogLine';
      // 0: messageType?
      //    00: message in chat box
      //        ex: "Tonk Tonkers: hello", "There are no party members." "You change to paladin."
      //    21: use action
      //        ex: clicking a button on your hotbar such as Sentinel or Goring Blade or Arm's Length
      //    26: gained an effect
      //        ex: getting a buff like Rampart or Sentinel or Arm's Length
      //    30: lose an effect
      //        ex: Rampart or Sentinel or Arm's Length wears off
      //    ex: "21|2023-01-16T13:37:49.1410000-05:00|107CDF82|Tonk Tonkers|16|Bulwark|107CDF82|Tonk Tonkers|640F|4D8000|0|0|0|0|0|0|0|0|0|0|0|0|0|0|98900|98900|10000|10000|||-87.90|51.12|1.50|-1.54|98900|98900|10000|10000|||-87.90|51.12|1.50|-1.54|0000130D|0|1|81681bf499192d9b"
      //        messageType: 21
      //        timeStamp: 21|2023-01-16T13:37:49.1410000-05:00|107CDF82
      //        actor?Id: 107CDF82
      //        actor?Name: Tonk Tonkers
      //        ???: 16
      //        Skill Name: Bulwark
      //        targetId: 107CDF82
      //        targetName: Tonk Tonkers
      //    ex: "26|2023-01-16T13:37:49.1410000-05:00|4D|Bulwark|10.00|107CDF82|Tonk Tonkers|107CDF82|Tonk Tonkers|00|98900|98900|b7ca294ce31f8663"
      //        messageType: 26
      //        timeStamp: 2023-01-16T13:37:49.1410000-05:00
      //        actionId: 4D
      //        actionName: Bulwark
      //        duration (seconds, 2 decimal places): 10.00
      //        actor?Id: 107CDF82
      //        actor?Name: Tonk Tonkers
      //        target?Id: 107CDF82
      //        target?Name: Tonk Tonkers
      //    ex: "30|2023-01-16T13:37:53.8630000-05:00|4D|Bulwark|0.00|107CDF82|Tonk Tonkers|107CDF82|Tonk Tonkers|00|98900|98900|ebfc01ff60fa6c8f"
      //        messageType: 30
      //        timeStamp: 2023-01-16T13:37:53.8630000-05:00
      //        actionId: 4D
      //        actionName: Bulwark
      //        duration (seconds, 2 decimal places): 0.00
      //        actor?Id: 107CDF82
      //        actor?Name: Tonk Tonkers
      //        target?Id: 107CDF82
      //        target?Name: Tonk Tonkers

      // We only want a few of the message types
      // Character uses ability: Display something in the overlay to so it feels
      //                         responsive
      // Character gains effect: Communicate that the character has the effect
      // Character loses effect: Communicate that the character no longer has
      //                         the effect
      const MESSAGE_TYPE_USE_ABILITY = '21'; // Character uses ability
      const MESSAGE_TYPE_GAIN_EFFECT = '26'; // Character gains effect
      const MESSAGE_TYPE_LOSE_EFFECT = '30'; // Character loses effect
      // All Message Types
      const messageTypes = [
        MESSAGE_TYPE_USE_ABILITY,
        MESSAGE_TYPE_GAIN_EFFECT,
        MESSAGE_TYPE_LOSE_EFFECT
      ];

      // Tank
      const ACTION_ID_ARMS_LENGTH = '4B9';
      const ACTION_ID_RAMPART = '4A7';
      // Gun Breaker
      // Dark Knight
      // Paladin
      const ACTION_ID_PALADIN_BULWARK = '4D';
      const ACTION_ID_PALADIN_DIVINE_VEIL = '552'; // shield
      const ACTION_ID_PALADIN_HALLOWED_GROUND = '52';
      const ACTION_ID_PALADIN_HOLY_SHELTRON = 'A72';
      const ACTION_ID_PALADIN_KNIGHTS_RESOLVE = 'A73'; // 4s mit from holy sheltron
      const ACTION_ID_PALADIN_SENTINEL = '4A';
      // Warrior
      const ACTION_ID_WARRIOR_BLOODWHETTING = 'A76';
      const ACTION_ID_WARRIOR_HOLMGANG = '199';
      const ACTION_ID_WARRIOR_STEM_THE_FLOW = 'A77'; // 4s mit from bloodwhetting
      const ACTION_ID_WARRIOR_STEM_THE_TIDE = 'A78'; // shield from bloodwhetting
      const ACTION_ID_WARRIOR_VENGEANCE = '59'; // thorns
      const ACTION_ID_WARRIOR_VULNERABILITY_DOWN = '390'; // mit from vengeance
      const ACTION_ID_WARRIOR_SHAKE_IT_OFF = '581'; // shield
      const ACTION_ID_WARRIOR_SHAKE_IT_OFF_OVER_TIME = '83C'; // healing from shake it off
      // All Mitigation Action IDs
      const actionIds = [
        ACTION_ID_ARMS_LENGTH,
        ACTION_ID_RAMPART,
        ACTION_ID_PALADIN_BULWARK,
        //ACTION_ID_PALADIN_DIVINE_VEIL,
        ACTION_ID_PALADIN_HALLOWED_GROUND,
        ACTION_ID_PALADIN_HOLY_SHELTRON,
        ACTION_ID_PALADIN_KNIGHTS_RESOLVE,
        ACTION_ID_PALADIN_SENTINEL,
        ACTION_ID_WARRIOR_BLOODWHETTING,
        ACTION_ID_WARRIOR_HOLMGANG,
        ACTION_ID_WARRIOR_STEM_THE_FLOW,
        ACTION_ID_WARRIOR_VULNERABILITY_DOWN
      ];

      const ACTION_ID_COLOR_MAP = {
        [ACTION_ID_ARMS_LENGTH]: '#ba7858',
        [ACTION_ID_RAMPART]: '#7098ef',
        [ACTION_ID_PALADIN_BULWARK]: '#91edff',
        [ACTION_ID_PALADIN_HALLOWED_GROUND]: '#f4e690',
        [ACTION_ID_PALADIN_HOLY_SHELTRON]: '#f17c71',
        [ACTION_ID_PALADIN_KNIGHTS_RESOLVE]: '#0a3c3d',
        [ACTION_ID_PALADIN_SENTINEL]: '#0051ab',
        [ACTION_ID_WARRIOR_BLOODWHETTING]: '#dc4e24',
        [ACTION_ID_WARRIOR_HOLMGANG]: '#dec5cd',
        [ACTION_ID_WARRIOR_STEM_THE_FLOW]: '#f4e690',
        [ACTION_ID_WARRIOR_VENGEANCE]: '#9e2eb0',
        [ACTION_ID_WARRIOR_VULNERABILITY_DOWN]: '#444444'
      };
      ACTION_ID_COLOR_MAP[ACTION_ID_ARMS_LENGTH] = '#ba7858';
      ACTION_ID_COLOR_MAP[ACTION_ID_RAMPART] = '#7098ef';
      ACTION_ID_COLOR_MAP[ACTION_ID_PALADIN_BULWARK] = '#91edff';
      ACTION_ID_COLOR_MAP[ACTION_ID_PALADIN_HALLOWED_GROUND] = '#f4e690';
      ACTION_ID_COLOR_MAP[ACTION_ID_PALADIN_HOLY_SHELTRON] = '#f17c71';
      ACTION_ID_COLOR_MAP[ACTION_ID_PALADIN_KNIGHTS_RESOLVE] = '#0a3c3d';
      ACTION_ID_COLOR_MAP[ACTION_ID_PALADIN_SENTINEL] = '#0051ab';
      ACTION_ID_COLOR_MAP[ACTION_ID_WARRIOR_BLOODWHETTING] = '#dc4e24';
      ACTION_ID_COLOR_MAP[ACTION_ID_WARRIOR_HOLMGANG] = '#dec5cd';
      ACTION_ID_COLOR_MAP[ACTION_ID_WARRIOR_STEM_THE_FLOW] = '#f4e690';
      ACTION_ID_COLOR_MAP[ACTION_ID_WARRIOR_VENGEANCE] = '#9e2eb0';
      ACTION_ID_COLOR_MAP[ACTION_ID_WARRIOR_VULNERABILITY_DOWN] = '#444444';

      const ACTION_ID_ICON_MAP = {
        [ACTION_ID_ARMS_LENGTH]: 'assets/icons/tank/arms_length.png',
        [ACTION_ID_RAMPART]: 'assets/icons/tank/rampart.png',
        [ACTION_ID_PALADIN_BULWARK]: 'assets/icons/pld/enhanced_sheltron.png',
        [ACTION_ID_PALADIN_HALLOWED_GROUND]: 'assets/icons/pld/hallowed_ground.png',
        [ACTION_ID_PALADIN_HOLY_SHELTRON]: 'assets/icons/pld/holy_sheltron.png',
        [ACTION_ID_PALADIN_SENTINEL]: 'assets/icons/pld/sentinel.png'
      };

      addOverlayListener(eventType, (data) => {
        const messageType = data.line[0];
        if(messageTypes.includes(messageType)){
          switch(messageType){
            case MESSAGE_TYPE_USE_ABILITY:
              if(debug){
                console.log('Used an ability');
                console.log(data);
              }
              break;
            case MESSAGE_TYPE_GAIN_EFFECT:
              if(debug){
                console.log('Gained an effect');
                console.log(data);
              }
              const actionId = data.line[2];
              if(data.line[8] === characterName && actionIds.includes(actionId)){
                const duration = data.line[4];
                createProgressBar(actionId, 100);
              }
              break;
            case MESSAGE_TYPE_LOSE_EFFECT:
              if(debug){
                console.log('Lost an effect');
                console.log(data);
              }
              break;
          }
        }
      });
      startOverlayEvents();

      function getProgressBarDashSize(){
        return Math.round(main.getBoundingClientRect().height);
      }

      function resizeProgressBars(){
        let dashSize = getProgressBarDashSize();
        progressBars.forEach(progressBar => {
          if(progressBar){
            const currentPercentage = progressBar.getAttribute('stroke-dashoffset') / progressBar.getAttribute('stroke-dasharray');
            progressBar.setAttribute('stroke-dasharray', dashSize);
            progressBar.setAttribute('stroke-dashoffset', dashSize * currentPercentage);
          }
        });
      }

      function createProgressBar(id, duration){
        const svgId = 'svg-' + id;
        const progressBarId = 'progressBar-' + id;
        const animationId = 'animation-' + id;
        const dashSize = getProgressBarDashSize();
        const ns = 'http://www.w3.org/2000/svg';

        const wrapper = document.createElement('div');
        wrapper.style.height = '100%';
        wrapper.style.display = 'inline-block';

        const svg = document.createElementNS(ns, 'svg');
        svg.setAttribute('id', svgId);
        svg.setAttribute('height', '100%');
        svg.setAttribute('viewBox', '0 0 70 266');
        svg.style.margin = ('0 30px 30px 0');

        const progressBar = document.createElementNS(ns, 'path');
        progressBar.setAttribute('id', progressBarId);
        progressBar.setAttribute('vector-effect', 'non-scaling-stroke');
        progressBar.setAttribute('fill', 'none');
        progressBar.setAttribute('stroke', ACTION_ID_COLOR_MAP[id] ? ACTION_ID_COLOR_MAP[id] : '#ffffff');
        progressBar.setAttribute('stroke-width', '10');
        progressBar.setAttribute('stroke-linecap', 'round');
        progressBar.setAttribute('stroke-dasharray', dashSize);
        progressBar.setAttribute('stroke-dashoffset', 25);
        progressBar.setAttribute('filter', 'drop-shadow(0 0 5px #000000)');
        // 25 seems to make it start more immediately, there is some offset here
        // that I can't figure out, I am sure a math whiz could run loops around
        // my approach to animating a curve
        // Note: this doesn't scale up too well, at like 600px+ it still hangs
        //       for a moment
        progressBar.setAttribute('d', "M 35.00,246.00 C 10.00,186.00 10.00,70.00 35.00,10.00");
        svg.appendChild(progressBar);
        wrapper.style.margin = '0 0 0 -' + ((dashSize * (70/260)) + 5) + 'px';

        const animation = document.createElementNS(ns, 'animate');
        animation.setAttribute('id', animationId);
        animation.setAttribute('attributeName', 'stroke-dashoffset');
        animation.setAttribute('from', 25);
        animation.setAttribute('to', dashSize);
        animation.setAttribute('dur', duration + 's');
        animation.setAttribute('fill', 'freeze');
        progressBar.appendChild(animation);

        progressBars.push(progressBar);

        if(ACTION_ID_ICON_MAP[id]){
          const icon = document.createElement('img');
          icon.src = ACTION_ID_ICON_MAP[id];
          icon.style.height = '30px';
          icon.style.width = '30px';
          icon.style.position = 'relative';
          icon.style.bottom = 'calc(7% + 20px)';
          icon.style.left = 'calc(50%)'; // not lined up in browser but is in ACT
          icon.style.opacity = '.9';
          icon.style.filter = 'drop-shadow(0 0 5px #000000)';
          wrapper.appendChild(icon);
        }

        wrapper.appendChild(svg);

        // TODO this should be replaced? work with? MESSAGE_TYPE_LOSE_EFFECT
        // Remove bar if timer expires
        setTimeout(function(){
          if(progressBar){
            progressBars.forEach((existingProgressBar, index) => {
              if(existingProgressBar.getAttribute('id') === progressBarId){
                progressBars.splice(index, 1);
              }
            });
            svg.parentNode.remove();
          }
        }, duration * 1000);

        if(main.children[0]){
          main.insertBefore(wrapper, main.children[0]);
        }
        else{
          main.appendChild(wrapper);
        }

        return progressBar;
      }

      // TODO: add a buffer here so it isn't doing this 100s of times while a
      //       user resizes the window
      window.addEventListener('resize', () => {
        resizeProgressBars();
      });
      resizeProgressBars();
    </script>
  </footer>
</html>
