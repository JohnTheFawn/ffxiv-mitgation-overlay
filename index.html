<!DOCTYPE html>
<html lang="en">
  <head>
    <script type="text/javascript" src="https://ngld.github.io/OverlayPlugin/assets/shared/common.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
      body{
        margin: 0px;
      }
      #main{
        height: 100vh;
        width: 100vw;
        overflow: hidden;
        text-align: right;
      }
      .progressBarRed{
        filter: invert(12%) sepia(73%) saturate(4547%) hue-rotate(354deg) brightness(95%) contrast(119%);
      }
      .progressBarBlue{
        filter: invert(11%) sepia(98%) saturate(6564%) hue-rotate(246deg) brightness(62%) contrast(136%);
      }
      .progressBarGreen{
        filter: invert(38%) sepia(99%) saturate(1478%) hue-rotate(91deg) brightness(95%) contrast(105%);
      }
      .progressBarWhite{
        filter: invert(100%) sepia(4%) saturate(18%) hue-rotate(109deg) brightness(105%) contrast(105%);
      }
    </style>
  </head>
  <body>
    <div id="main">
      <svg id="svg"
        xmlns="http://www.w3.org/2000/svg"
        height="100%"
        viewBox="0 0 60 266"
      >
        <!--
        <path
          id="path"
          vector-effect="non-scaling-stroke"
          fill="none"
          stroke="black"
          stroke-width="10"
          stroke-linecap="round"
          d="M 30.00,246.00
             C 0.00,186.00 0.00,70.00 30.00,10.00"
          >
        </path>
        <path
          id="loader1"
          vector-effect="non-scaling-stroke"
          fill="none"
          stroke="green"
          stroke-width="10"
          stroke-linecap="round"
          stroke-dasharray="758"
          stroke-dashoffset="758"
          d="M 30.00,246.00
             C 0.00,186.00 0.00,70.00 30.00,10.00"
          >
        </path>
      -->
      </svg>
    </div>
  </body>
  <footer>
    <script>
      // Will be used to hold our progress bars for easy access
      const progressBars = [document.getElementById('loader1')];

      // Contents vary based on messageType
      const eventType = 'LogLine';
      // 0: messageType?
      //    00: message in chat box
      //        ex: "Tonk Tonkers: hello", "There are no party members." "You change to paladin."
      //    21: use action
      //        ex: clicking a button on your hotbar such as Sentinel or Goring Blade or Arm's Length
      //    26: gained an effect
      //        ex: getting a buff like Rampart or Sentinel or Arm's Length
      //    30: lose an effect
      //        ex: Rampart or Sentinel or Arm's Length wears off
      //    ex: "21|2023-01-16T13:37:49.1410000-05:00|107CDF82|Tonk Tonkers|16|Bulwark|107CDF82|Tonk Tonkers|640F|4D8000|0|0|0|0|0|0|0|0|0|0|0|0|0|0|98900|98900|10000|10000|||-87.90|51.12|1.50|-1.54|98900|98900|10000|10000|||-87.90|51.12|1.50|-1.54|0000130D|0|1|81681bf499192d9b"
      //        messageType: 21
      //        timeStamp: 21|2023-01-16T13:37:49.1410000-05:00|107CDF82
      //        actor?Id: 107CDF82
      //        actor?Name: Tonk Tonkers
      //        ???: 16
      //        Skill Name: Bulwark
      //        target?Id: 107CDF82
      //        target?Name: Tonk Tonkers
      //    ex: "26|2023-01-16T13:37:49.1410000-05:00|4D|Bulwark|10.00|107CDF82|Tonk Tonkers|107CDF82|Tonk Tonkers|00|98900|98900|b7ca294ce31f8663"
      //        messageType: 26
      //        timeStamp: 2023-01-16T13:37:49.1410000-05:00
      //        actionId: 4D
      //        actionName: Bulwark
      //        duration (seconds, 2 decimal places): 10.00
      //        actor?Id: 107CDF82
      //        actor?Name: Tonk Tonkers
      //        target?Id: 107CDF82
      //        target?Name: Tonk Tonkers
      //    ex: "30|2023-01-16T13:37:53.8630000-05:00|4D|Bulwark|0.00|107CDF82|Tonk Tonkers|107CDF82|Tonk Tonkers|00|98900|98900|ebfc01ff60fa6c8f"
      //        messageType: 30
      //        timeStamp: 2023-01-16T13:37:53.8630000-05:00
      //        actionId: 4D
      //        actionName: Bulwark
      //        duration (seconds, 2 decimal places): 0.00
      //        actor?Id: 107CDF82
      //        actor?Name: Tonk Tonkers
      //        target?Id: 107CDF82
      //        target?Name: Tonk Tonkers

      // We only want a few of the message types
      // Character uses ability: Display something in the overlay to so it feels
      //                         responsive
      // Character gains effect: Communicate that the character has the effect
      // Character loses effect: Communicate that the character no longer has
      //                         the effect
      const MESSAGE_TYPE_USE_ABILITY = '21'; // Character uses ability
      const MESSAGE_TYPE_GAIN_EFFECT = '26'; // Character gains effect
      const MESSAGE_TYPE_LOSE_EFFECT = '30'; // Character loses effect
      // All Message Types
      const messageTypes = [
        MESSAGE_TYPE_USE_ABILITY,
        MESSAGE_TYPE_GAIN_EFFECT,
        MESSAGE_TYPE_LOSE_EFFECT
      ];

      // We will need filter down to just the mits
      const ACTION_ID_ARMS_LENGTH = '4B9';
      // Gun Breaker
      // Dark Knight
      // Paladin
      const ACTION_ID_PALADIN_BULWARK = '4D';
      const ACTION_ID_PALADIN_DIVINE_VEIL = '552';
      const ACTION_ID_PALADIN_HALLOWED_GROUND = '52';
      const ACTION_ID_PALADIN_RAMPART = '4A7';
      const ACTION_ID_PALADIN_SENTINEL = '4A';
      // Warrior
      // All Mitigation Action IDs
      const actionIds = [
        ACTION_ID_ARMS_LENGTH,
        ACTION_ID_PALADIN_BULWARK,
        ACTION_ID_PALADIN_DIVINE_VEIL,
        ACTION_ID_PALADIN_HALLOWED_GROUND,
        ACTION_ID_PALADIN_RAMPART,
        ACTION_ID_PALADIN_SENTINEL
      ];

      addOverlayListener(eventType, (data) => {
        const messageType = data.line[0];
        if(messageTypes.includes(messageType)){
          switch(messageType){
            case MESSAGE_TYPE_USE_ABILITY:
              console.log('Used an ability');
              console.log(data);
              break;
            case MESSAGE_TYPE_GAIN_EFFECT:
              console.log('Gained an effect');
              console.log(data);
              break;
            case MESSAGE_TYPE_LOSE_EFFECT:
              console.log('Lost an effect');
              console.log(data);
              break;
          }
        }
      });
      startOverlayEvents();

      function getProgressBarDashSize(){
        return Math.round(document.getElementById('main').getBoundingClientRect().height);
      }

      function resizeProgressBars(){
        const dashSize = getProgressBarDashSize();
        progressBars.forEach(progressBar => {
          if(progressBar){
            const currentPercentage = progressBar.getAttribute('stroke-dashoffset') / progressBar.getAttribute('stroke-dasharray');
            progressBar.setAttribute('stroke-dasharray', dashSize);
            progressBar.setAttribute('stroke-dashoffset', dashSize * currentPercentage);
          }
        });
      }

      function createProgressBar(id, duration){
        const progressBar = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        //const progressBarId = 'progressBar-' + effectName.replace(/ /g, '_');
        const progressBarId = 'loader2';
        const dashSize = getProgressBarDashSize();

        progressBar.setAttribute('id', id);
        progressBar.setAttribute('vector-effect', 'non-scaling-stroke');
        progressBar.setAttribute('fill', 'none');
        progressBar.setAttribute('stroke', 'blue');
        progressBar.setAttribute('stroke-width', '10');
        progressBar.setAttribute('stroke-linecap', 'round');
        progressBar.setAttribute('stroke-dasharray', dashSize);
        progressBar.setAttribute('stroke-dashoffset', 25);
        // 25 seems to make it start more immediately there is some offset here
        // that I can't figure out, I am sure a math whiz could run loops around
        // my approach to animating a bezier curve
        // Note: this doesn't scale up too well, at like 600px+ it still hangs
        //       for a moment
        progressBar.setAttribute('d', "M 30.00,246.00 C 0.00,186.00 0.00,70.00 30.00,10.00");

        const animation = document.createElementNS('http://www.w3.org/2000/svg', 'animate');
        animation.setAttribute('attributeName', 'stroke-dashoffset');
        animation.setAttribute('from', 25);
        animation.setAttribute('to', dashSize);
        animation.setAttribute('dur', duration + 's');
        animation.setAttribute('fill', 'freeze');
        progressBar.appendChild(animation);

        progressBars.push(progressBar);

        setTimeout(function(){
          if(progressBar){
            progressBar.parentNode.removeChild(progressBar);
          }
        }, duration * 1000);

        return progressBar;
      }

      function sanitizeEffect(effect){
        return effect.toLowerCase().replace(/\W/g, '');
      }

      document.getElementById('svg').appendChild(
        createProgressBar(
          sanitizeEffect('Arm\'s Length'),
          6
        )
      );

      // TODO: add a buffer here so it isn't doing this 100s of times while a
      //       user resizes the window
      window.addEventListener('resize', () => {
        resizeProgressBars();
      });
      resizeProgressBars();
    </script>
  </footer>
</html>
